!function(){function t(e,i,n){function a(r,s){if(!i[r]){if(!e[r]){var l="function"==typeof require&&require;if(!s&&l)return l(r,!0);if(o)return o(r,!0);var c=new Error("Cannot find module '"+r+"'");throw c.code="MODULE_NOT_FOUND",c}var u=i[r]={exports:{}};e[r][0].call(u.exports,function(t){var i=e[r][1][t];return a(i||t)},u,u.exports,t,e,i,n)}return i[r].exports}for(var o="function"==typeof require&&require,r=0;r<n.length;r++)a(n[r]);return a}return t}()({1:[function(t,e,i){function n(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,i){function n(a,o){try{var r=e[a](o),s=r.value}catch(l){return void i(l)}return r.done?void t(s):Promise.resolve(s).then(function(t){n("next",t)},function(t){n("throw",t)})}return n("next")})}}Object.defineProperty(i,"__esModule",{value:!0});var a=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.plugin,i=t.service;this.createMapImage=function(){return i.createMapImage()},this.calcola=function(t){return i.calcola(t)},this.wrapMethod=function(t){i.wrapMethod(t)},this.showCduPanel=n(regeneratorRuntime.mark(function a(){var t=this,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=(o.options,o.config),s=void 0===r?{}:r,l=o.features,c=void 0===l?[]:l,u=o.calcola;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:e.showSearchPanel(s).then(function(){var e=n(regeneratorRuntime.mark(function a(e){var n,o,r=e.panel;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=r.getService(),i.setupConfig(s),o=n.getCatastoFields(),i.addParticelle({particelle:c,catastoFields:o}),n._showContent(c,u),t.next=7,Vue.nextTick();case 7:case"end":return t.stop()}},a,t)}));return function(t){return e.apply(this,arguments)}}());case 1:case"end":return a.stop()}},a,this)}))};i["default"]=a},{}],2:[function(t,e,i){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._calcola=t.calcola,this.throttles={hightLightGeometry:{fnc:function(){a.hightLightGeometry.apply(a,arguments)},delay:1e3}},l(this),this.state=a.state}var a=t("../pluginservice"),o=t("./vue/calcolo"),r=g3wsdk.core.G3WObject,s=g3wsdk.core.utils.inherit,l=g3wsdk.core.utils.base,c=g3wsdk.core.i18n.t,u=g3wsdk.gui.GUI;s(n,r);var d=n.prototype;d.clear=function(){a.clearFeaturesandInteractions()},d.calcola=function(t,e){var i=$.Deferred();return a.disablePanel(!0),a.disableAllInteractions(),a.clearIntersectLayer(),this._calcola?this._calcola().then(function(){i.resolve()})["catch"](function(){u.notify.error(c("server_error")),i.reject()})["finally"](function(){a.disablePanel(!1)}):a.calcola(t.api).then(function(n){u.pushContent({content:new o({state:n,catastoFields:e,urls:t}),backonclose:!0,closable:!1,perc:50,title:"Crea Report"}),i.resolve()}).fail(function(){a.disablePanel(!1),u.notify.error(c("server_error")),i.reject()}),i.promise()},d.deleteParticelle=function(){a.deleteParticelle()},d.deleteParticella=function(t){a.deleteParticella(t)},d.activeInteraction=function(t){a.activeInteraction(t)},e.exports=n},{"../pluginservice":10,"./vue/calcolo":4}],3:[function(t,e,i){e.exports='<div id="cdu-calcolo" style="margin-top: 5px">\n  <div style="font-weight: bold; background-color: white; padding:5px; border-radius: 3px; margin-bottom: 5px;">\n    <div style="margin-bottom: 5px;">* Superficie come riveniente dagli atti catastali della Agenzia delle Entrate</div>\n    <div>** Superficie geometrica calcolata automaticamente dal poligono di interrogazione poiché l\'informazione è assente dagli atti catastali dell’Agenzia delle Entrate</div>\n  </div>\n  <div class="text-right">\n    <button data-toggle="tooltip" title="Download" :disabled="loading" class="btn btn-lg skin-button skin-tooltip-top" @click="createDoc()" style="border:5px solid #ffffff; border-radius: 50%; margin-bottom: 5px;">\n      <span style="font-size: 1.5em"  :class="g3wtemplate.getFontClass(\'file-download\')"></span>\n    </button>\n  </div>\n  <div class="results">\n    <div v-for="particella, idParticella in state">\n      <div class="table-header-tool">\n        <span v-for="field in getCatastoFieldsFromResults(particella)">\n          <b> {{ field.label }} : {{ field.value }} </b>\n        </span>\n      </div>\n      <div v-t-plugin="\'cdu.messages.nointersections\'" v-if="!particella.results.length">\n      </div>\n      <div class="table-responsive" v-else>\n        <table class="table table-hover">\n          <thead>\n            <tr>\n              <th></th>\n              <th v-show="false" style="padding-bottom:3px;">\n                <input :id="idParticella" type="checkbox" v-model="parentCheckBoxes[idParticella].checked" class="magic-checkbox pull-right">\n                <label v-t-plugin="\'cdu.buttons.confirm\'" :for="idParticella"></label>\n              </th>\n              <th v-t-plugin="\'cdu.table.header.compare\'"></th>\n              <th v-t-plugin="\'cdu.table.header.type\'"></th>\n              <th v-t-plugin="\'cdu.table.header.fields\'"></th>\n              <th v-t-plugin:pre="\'cdu.table.header.area\'"> | % <span style="font-weight: bold">({{particella.censuario_area ? \'*\' : \'**\'}})</span></th>\n            </tr>\n          </thead>\n          <tbody>\n            <tr v-for="intersection in particella.results">\n              <td @mouseover="highLightIntersection(intersection.geometry, false)">\n                <span v-if="intersection.geometry"  @click="highLightIntersection(intersection.geometry, true)" :class="g3wtemplate.getFontClass(\'marker\')" class="action-button action-button-icon"></span>\n              </td>\n              <td v-show="false">\n                <input :id="\'intersection_\'+intersection.id" class="magic-checkbox intersection" v-model="parentCheckBoxes[idParticella].childs[intersection.id]" type="checkbox">\n                <label :for="\'intersection_\'+intersection.id"></label>\n              </td>\n              <td>{{intersection.alias }}</td>\n              <td>{{intersection.geometry ? intersection.geometry.type : \'\' }}\n              </td>\n              <td>\n                <p v-for="field in intersection.fields">{{ field.alias }} : {{ field.value }}</p>\n              </td>\n              <td>{{ intersection.area || 0 }} mq | {{ intersection.perc || 0 }} %</td>\n            </tr>\n          </tbody>\n        </table>\n      </div>\n    </div>\n  </div>\n</div>\n'},{}],4:[function(t,e,i){function n(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,i){function n(a,o){try{var r=e[a](o),s=r.value}catch(l){return void i(l)}return r.done?void t(s):Promise.resolve(s).then(function(t){n("next",t)},function(t){n("throw",t)})}return n("next")})}}function a(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};s(this,t);var e=t.state||{},i=t.catastoFields,n=t.urls,a={},o=function(t){var i=e[t];a[t]={checked:!0,childs:{}},i.results.forEach(function(e){a[t].childs[e.id]=!0}),h["parentCheckBoxes."+t+".checked"]=function(t){return function(e,i){_.forEach(a[t].childs,function(i,n){a[t].childs[n]=e})}}(t)};for(var r in e)o(r);this.setInternalComponent(new p({state:e,catastoFields:i,urls:n,parentCheckBoxes:a}))}var o=g3wsdk.core.utils.inherit,r=g3wsdk.core.i18n.t,s=g3wsdk.core.utils.base,l=g3wsdk.gui.GUI,c=g3wsdk.gui.vue.Component,u=g3wsdk.core.utils.XHR,d=t("../../pluginservice"),h={},p=Vue.extend({template:t("./calcolo.html"),data:function(){return{loading:!1,state:this.$options.state,catastoFields:this.$options.catastoFields,docurl:this.$options.urls.docurl,uploadurl:this.$options.urls.uploadurl,parentCheckBoxes:this.$options.parentCheckBoxes}},methods:{getCatastoFieldsFromResults:function(t){var e=[];return _.forEach(this.catastoFields,function(i){e.push({label:i.label,value:t[i.field]})}),e},highLightIntersection:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t&&d.highLightIntersectFeature(t,{zoom:e})},getIdsChecked:function(){var t=[];return _.forEach(this.parentCheckBoxes,function(e){_.forEach(e.childs,function(e,i){e&&t.push(1*i)})}),t},hasChildCheck:function(t){var e=!1;return _.forEach(this.parentCheckBoxes[t].childs,function(t,i){t&&(e=!0)}),e},createDoc:function(){function t(){return e.apply(this,arguments)}var e=n(regeneratorRuntime.mark(function i(){var t,e,n,a,o,s,c;return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return l.setLoadingContent(!0),i.prev=1,t=this.getIdsChecked(),i.next=5,d.createMapImage();case 5:return e=i.sent,n=this.$cookie.get("csrftoken"),a={map_image:e,csrfmiddlewaretoken:n},i.next=10,u.post({url:this.uploadurl,data:a,formdata:!0});case 10:return o=i.sent,s=o.map_image.value,c=d.getOutputFormat(),i.next=15,u.fileDownload({url:this.docurl,data:{id:t.join(),map_image:s,format:c}});case 15:l.setLoadingContent(!1),i.next=22;break;case 18:i.prev=18,i.t0=i["catch"](1),l.notify.error(r("server_error")),l.setLoadingContent(!1);case 22:case"end":return i.stop()}},i,this,[[1,18]])}));return t}()},watch:h,created:function(){},beforeDestroy:function(){d.disablePanel(!1)}});o(a,c),e.exports=a},{"../../pluginservice":10,"./calcolo.html":3}],5:[function(t,e,i){e.exports='<div id="cdu" style="margin-top: 5px;">\n  <bar-loader :loading="state.loading"></bar-loader>\n  <div id="cdu-tools">\n    <div class="group-tools btn-group" style="margin-bottom: 5px; display:flex; align-items: center; justify-content: space-between;">\n      <div>\n        <!--controlli feature singola-->\n        <!--<button data-toggle="tooltip" @click="activeInteraction(\'modify\')" :class="{\'skin-button lighten bordered\' : \'modify\' === state.buttonToggled }" :title="tooltips.vertex" type="button" class="btn btn-default skin-tooltip-top cdu-tool-button" >-->\n          <!--<img :src="resourcesurl+\'images/cduMoveVertexFeature.png\'">-->\n        <!--</button>-->\n        <!--<button  data-toggle="tooltip" @click="activeInteraction(\'rotate\')" :class="{\'skin-button lighten bordered\' : \'rotate\' === state.buttonToggled }" :title="tooltips.rotate" type="button" class="btn btn-default skin-tooltip-top cdu-tool-button">-->\n          <!--<img :src="resourcesurl+\'images/cduRotateFeature.png\'">-->\n        <!--</button>-->\n        <!--<button style="margin-right: 20px;" data-toggle="tooltip" @click="activeInteraction(\'move\')" :class="{\'skin-button lighten bordered\' : \'move\' === state.buttonToggled }" :title="tooltips.move" type="button" class="btn btn-default skin-tooltip-top cdu-tool-button">-->\n          <!--<img :src="resourcesurl+\'images/cduMoveFeature.png\'">-->\n        <!--</button>-->\n        <!--&lt;!&ndash;fine controlli feature singola&ndash;&gt;-->\n        <!--&lt;!&ndash;controlli multi features&ndash;&gt;-->\n        <!--<button  data-toggle="tooltip" @click="activeInteraction(\'rotateall\')" :class="{\'skin-button lighten bordered\' : \'rotateall\' === state.buttonToggled }" :title="tooltips.rotateall" type="button" class="btn btn-default skin-tooltip-top cdu-tool-button">-->\n          <!--<img :src="resourcesurl+\'images/cduRotateFeatures.png\'">-->\n        <!--</button>-->\n        <!--<button  data-toggle="tooltip" @click="activeInteraction(\'moveall\')" :class="{\'skin-button lighten bordered\' : \'moveall\' === state.buttonToggled }" :title="tooltips.moveall" type="button" class="btn btn-default  skin-tooltip-top cdu-tool-button">-->\n          <!--<img :src="resourcesurl+\'images/cduMoveFeatures.png\'">-->\n        <!--</button>-->\n        <!--fine controlli multi features-->\n      </div>\n      <div style="align-self: baseline">\n        <button data-toggle="tooltip" :disabled="!particelle.length" @click="calcola" :class="{\'skin-background-color\': buttons.calculate }" v-t-tooltip="\'plugins.cdu.tooltips.calculate\'" class="skin-tooltip-top cdu-tool-button calculate-button">\n          <span style="padding:5px; border-radius: 30%; background-color: #f4f4f4;" :class="g3wtemplate.getFontClass(\'calculator\')" class="fa-2x skin-color" aria-hidden="true"></span>\n        </button>\n      </div>\n    </div>\n  </div>\n  <div v-if="particelle.length" class="cdu-parcels-list">\n    <table class="particelle table table-hover">\n      <thead>\n        <tr>\n          <th></th>\n          <th v-for="catastoField in catastoFields">{{ catastoField.label }}</th>\n          <th>\n            <i style="color:red; font-size: 1.1em;"  data-toggle="tooltip" v-t-tooltip="\'plugins.cdu.tooltips.deleteall\'" @click="deleteParticelle" :class="g3wtemplate.getFontClass(\'trash\')" class="skin-tooltip-top action-button pull-right"></i></th>\n        </tr>\n      </thead>\n      <tbody>\n        <tr @mouseover="hightLightGeometry(particella.getGeometry(), false)" v-for="particella in particelle">\n          <td>\n            <span @click="hightLightGeometry(particella.getGeometry(), true)" :class="g3wtemplate.getFontClass(\'marker\')" class="action-button action-button-icon"></span>\n          </td>\n          <td v-for="catastoField in catastoFields">\n            {{ getCatastoFieldValue(particella,catastoField) }}\n          </td>\n          <td>\n            <i style="color:red" @click="deleteParticella(particella)" :class="g3wtemplate.getFontClass(\'trash\')" class="action-button pull-right"></i>\n          </td>\n        </tr>\n      </tbody>\n    </table>\n  </div>\n</div>\n'},{}],6:[function(t,e,i){function n(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,i){function n(a,o){try{var r=e[a](o),s=r.value}catch(l){return void i(l)}return r.done?void t(s):Promise.resolve(s).then(function(t){n("next",t)},function(t){n("throw",t)})}return n("next")})}}function a(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.id="cdu",t.resizable=!0,r(this,t);var e=t.particelle||[],i=t.calcola,n=t.urls,a=t.catastoFields,o=new c({calcola:i});this.setService(o);var s=new u({urls:n,service:o,particelle:e,catastoFields:a});this.setInternalComponent(s),this.unmount=function(){return o.clear(),r(this,"unmount")}}var o=g3wsdk.core.utils.inherit,r=g3wsdk.core.utils.base,s=g3wsdk.gui.vue.Component,l=g3wsdk.gui.GUI,c=t("../cduservice"),u=Vue.extend({template:t("./cdu.html"),data:function(){return{state:this.$options.service.state,particelle:this.$options.particelle,catastoFields:this.$options.catastoFields,resourcesurl:l.getResourcesUrl(),buttons:{calculate:!1}}},methods:{layout:function(t){var e=t.height,i=(t.width,e-$("#cdu-tools").height()-20);$(".cdu-parcels-list").height(i)},removeTooltip:function(){$("#cdu .tooltip").remove()},calcola:function(){function t(){return e.apply(this,arguments)}var e=n(regeneratorRuntime.mark(function i(){var t=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.buttons.calculate=!0,this.removeTooltip(),this.state.loading=!0,e.next=5,this.$nextTick();case 5:this.$options.service.calcola(this.$options.urls,this.catastoFields).fail(function(){}).always(function(){t.buttons.calculate=!1,t.state.loading=!1});case 6:case"end":return e.stop()}},i,this)}));return t}(),deleteParticelle:function(){this.particelle.splice(0),this.$options.service.deleteParticelle()},deleteParticella:function(t){for(var e in this.particelle)t===this.particelle[e]&&this.particelle.splice(e,1);this.$options.service.deleteParticella(t)},activeInteraction:function(t){this.removeTooltip(),this.$options.service.activeInteraction(t)},clear:function(){this.particelle.splice(0)},getCatastoFieldValue:function(t,e){var i=t.getProperties();return i[e.field]},hightLightGeometry:function(t,e){this.$options.service.hightLightGeometry(t,e)}},mounted:function(){this.$nextTick(function(){$('#cdu [data-toggle="tooltip"]').tooltip()})},beforeDestroy:function(){this.clear()}});o(a,s),e.exports=a},{"../cduservice":2,"./cdu.html":5}],7:[function(t,e,i){Object.defineProperty(i,"__esModule",{value:!0}),i["default"]={it:{title:"Calcola CDU",buttons:{add:"Aggiungi",cached:"Ripeti ultima ricerca",calculate:"CALCOLA",downloadodt:"odt",confirm:"Accetta"},table:{header:{compare:"Confronto",type:"Tipo",fields:"Campi",area:"Area"}},messages:{invalidform:"Compila la ricerca in tutti i suoi campi",notfound:"Nessuna particella trovata",added:"La particella è stata già aggiunta",nointersections:"Non ci sono intesezioni"},tooltips:{deleteall:"Cancella particelle",vertex:"Vertici",rotate:"Ruota",move:"Muovi feature",moveall:"Muovi tutte le features",rotateall:"Ruota tutte le features",calculate:"Calcola",addfrommap:"Aggiungi particella da mappa"}},en:{title:"CDU",buttons:{add:"Add",cached:"Open last Search",calculate:"CALCULATE",downloadodt:"odt",confirm:"Confirm"},table:{header:{compare:"Compare",type:"Type",fields:"Fields",area:"Area"}},messages:{invalidform:"Please fill all fields",notfound:"Parcel not found",added:"Parcel already added",nointersections:"No intersections found"},tooltips:{deleteall:"Delete all",vertex:"Vertex",rotate:"Rotate",move:"Move feature",moveall:"Move all features",rotateall:"Rotate all features",calculate:"Calculate",addfrommap:"Add parcel from map"}}}},{}],8:[function(t,e,i){function n(t){return t&&t.__esModule?t:{"default":t}}Object.defineProperty(i,"__esModule",{value:!0});var a=t("./i18n"),o=n(a);i["default"]={i18n:o["default"]}},{"./i18n":7}],9:[function(t,e,i){function n(t){return t&&t.__esModule?t:{"default":t}}var a=t("api"),o=n(a),r=t("./config"),s=n(r),l=g3wsdk.core.utils.inherit,c=g3wsdk.core.utils.base,u=g3wsdk.core.plugin.Plugin,d=g3wsdk.gui.GUI,h=t("./pluginservice"),p=t("./search/vue/searchpanel"),f=g3wsdk.core.i18n.addI18nPlugin,v=function(){c(this),this.init=function(){this.name="cdu",this.setService(h);var t=new o["default"]({service:this.service,plugin:this});this.setApi(t),this.config=this.getConfig(),this.registerPlugin(this.config.gid)&&(d.ready?this.setupGui():d.once("ready",this.setupGui.bind(this)),this.setReady(!0)),f({name:this.name,config:s["default"].i18n})},this.setupGui=function(){var t=this.config.title||"CDU",e=this.config.position&&this.config.position||"tools";this.addTools({hook:e,icon:"calculator",action:this.showSearchPanel},{position:1,title:t})},this.showSearchPanel=function(t){var e=this;return new Promise(function(i,n){e.service.setupConfig(t);var a=t.search,o=new p(a,t);d.showPanel(o).then(function(t){i({content:t,panel:o})})})},this.unload=function(){this.removeTools(),this.service.unload()}};l(v,u),function(t){t.init()}(new v)},{"./config":8,"./pluginservice":10,"./search/vue/searchpanel":13,api:1}],10:[function(t,e,i){function n(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,i){function n(a,o){try{var r=e[a](o),s=r.value}catch(l){return void i(l)}return r.done?void t(s):Promise.resolve(s).then(function(t){n("next",t)},function(t){n("throw",t)})}return n("next")})}}function a(){var t=this;r(this),this._mapService=s.getComponent("map").getService(),this._map=null,this._interactions,this._currentId,this._layer,this._catastoLayer,this._outputformat,this._map_image,this._hideidMap,this._previousExtent,this._activeInteraction,this._selectInteraction,this._keyPickedEvent,this._wrapMethods={},this._cachedFeatures={},this.state={buttonToggled:null,loading:!1},this._mapService.onafter("controlClick",function(e){e&&t._interactions&&t._selectInteraction&&(t.disableInteractions({all:!0}),t.emit("disable-all-interactions"))}),this.setupConfig=function(t){this._currentId=t.id,this._cachedFeatures[t.id]||(this._cachedFeatures[t.id]=[]);var e=t.layerCatasto;this._catastoLayer=this._mapService.getProjectLayer(e);var i=this._catastoLayer.getCrs();this._outputformat=t.outputformat||"odt",this._map_image=t.map_image||"map",this._layer=new ol.layer.Vector({title:"CDUCatasto",source:new ol.source.Vector({projection:"EPSG:"+i,format:new ol.format.GeoJSON}),style:new ol.style.Style({stroke:new ol.style.Stroke({color:"#0000ff",width:3}),fill:new ol.style.Fill({color:"rgba(0,0,255,0.1)"})})}),this._intersectLayer=new ol.layer.Vector({title:"CDUOverlay",source:new ol.source.Vector({projection:"EPSG:"+i,format:new ol.format.GeoJSON}),style:new ol.style.Style({stroke:new ol.style.Stroke({color:"#1cc223",width:1}),fill:new ol.style.Fill({color:"rgba(0,255,0,0.9)"})})}),this._map=null===this._map?this._mapService.getMap():this._map,this._map.addLayer(this._layer),this._map.addLayer(this._intersectLayer),this._selectInteraction=new ol.interaction.Select({layers:[this._layer],style:new ol.style.Style({stroke:new ol.style.Stroke({color:"#0000ff",width:3}),fill:new ol.style.Fill({color:"rgba(0,0,255,0.1)"})})}),this._interactions={pick_feature:new c({}),rotate:new ol.interaction.RotateFeature({features:this._selectInteraction.getFeatures(),angle:0}),move:new ol.interaction.Translate({features:this._selectInteraction.getFeatures()}),modify:new ol.interaction.Modify({features:this._selectInteraction.getFeatures()}),snap:new ol.interaction.Snap({source:this._layer.getSource()}),rotateall:new ol.interaction.RotateFeature({features:this._selectInteraction.getFeatures(),angle:0}),moveall:new ol.interaction.Translate({features:this._selectInteraction.getFeatures()})},this._map.addInteraction(this._selectInteraction),this._selectInteraction.setActive(!1);for(var n in this._interactions){var a=this._interactions[n];this._map.addInteraction(a),a.setActive(!1)}"layer"===this._map_image&&this._setupHideMap()},this.getOutputFormat=function(){return this._outputformat},this.getMapService=function(){return this._mapService},this.getProjectLayer=function(t){return this._mapService.getProjectLayer(t)},this.deactiveMapControls=function(){this._mapService.deactiveMapControls()},this._getFeaturesFromPickCoordinateInteraction=n(regeneratorRuntime.mark(function e(){var t,i,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=n.coordinates,o=n.catastoFields;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._mapService.getQueryLayerByCoordinates({layer:this._catastoLayer,coordinates:a});case 3:return t=e.sent,i=this.parseQueryResults(t.data),e.abrupt("return",this.addParticelle({particelle:i,catastoFields:o,zoom:!1}));case 8:e.prev=8,e.t0=e["catch"](0),s.notify.error(l("server_error"));case 11:case"end":return e.stop()}},e,this,[[0,8]])})),this.activeGeoSearchInteraction=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=e.active,a=void 0!==i&&i,o=e.catastoFields,r=e.callback,s=void 0===r?function(){}:r;if(a&&this._mapService.deactiveMapControls(),this._interactions.pick_feature.setActive(a),a){var l=regeneratorRuntime.mark(function h(t){var e,i=t.coordinates,n=t.catastoFields;return regeneratorRuntime.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=3,regeneratorRuntime.awrap(c._getFeaturesFromPickCoordinateInteraction({coordinates:i,catastoFields:n}));case 3:return e=t.sent,t.next=6,e;case 6:i=t.sent,t.next=0;break;case 9:case"end":return t.stop()}},h,this)}),c=this,u=null;this._keyPickedEvent=this._interactions.pick_feature.on("picked",d(function(){var e=n(regeneratorRuntime.mark(function i(e){var n,a;return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return t.emit("picked-particella"),n=e.coordinate,a=void 0,u||(u=l({coordinates:n,catastoFields:o})),i.next=6,u.next(n);case 6:a=i.sent,s(a.value);case 8:case"end":return i.stop()}},i,t)}));return function(t){return e.apply(this,arguments)}}()))}else this._keyPickedEvent&&ol.Observable.unByKey(this._keyPickedEvent),this._keyPickedEvent=null},this.parseQueryResults=function(t){if(t){var e=s.getComponent("queryresults").getService(),i=e._digestFeaturesForLayers(t);return i.length?i[0].features:i}},this._getParticelleToAdd=function(t,e){var i={message:!1,features:[]};if(t.length){var n=this._layer.getSource().getFeatures();n.length?(i.features=t.filter(function(t){return!n.find(function(i){for(var n=!0,a=0;a<e.length;a++){var o=e[a].field;n=n&&t.attributes[o]===i.get(o)}return n})}),i.message=!i.features.length&&"added"):i.features=t}else i.message="notfound";return i},this.deleteParticelle=function(){this._layer.getSource().clear(),s.closeContent()},this.deleteParticella=function(t){this._layer.getSource().removeFeature(t),this._layer.setVisible(!0),!this._layer.getSource().getFeatures().length&&s.closeContent()},this.addParticella=function(t){this._catastoLayer.setVisible(!0),this._layer.getSource().addFeature(t)},this.addParticelle=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.particelle,i=void 0===e?[]:e,n=t.catastoFields,a=t.zoom,o=void 0===a||a,r=this._getParticelleToAdd(i,n),s=r.message,l=r.features,c=[],u=!0,d=!1,h=void 0;try{for(var p,f=l[Symbol.iterator]();!(u=(p=f.next()).done);u=!0){var v=p.value,g=v instanceof ol.Feature?v:new ol.Feature({geometry:v.geometry});for(var m in v.attributes){var b=v.attributes[m];g.set(m,b)}this.addParticella(g),this._activeInteraction&&this._activeInteraction.indexOf("all")>-1&&this._selectInteraction.getFeatures().push(g),o&&this._mapService.highlightGeometry(g.getGeometry(),{duration:1e3}),c.push(g)}}catch(y){d=!0,h=y}finally{try{!u&&f["return"]&&f["return"]()}finally{if(d)throw h}}return{message:s,features:c}},this.removeLayersandInteractions=function(){this._map.removeLayer(this._layer),this._map.removeLayer(this._intersectLayer),this._map.removeInteraction(this._selectInteraction);for(var t in this._interactions){var e=this._interactions[t];this._map.removeInteraction(e)}},this.getCachedParticelle=function(){return this._cachedFeatures[this._currentId]},this.showCachedParticelle=function(){return this._layer.getSource().addFeatures(this._cachedFeatures[this._currentId]),this._cachedFeatures[this._currentId]},this.clearFeaturesandInteractions=function(){var t=this;this._cachedFeatures[this._currentId].splice(0),this._layer.getSource().getFeatures().forEach(function(e){t._cachedFeatures[t._currentId].push(e.clone())}),this._layer.getSource().clear(),this._intersectLayer.getSource().clear(),this.disableInteractions()},this.clear=function(){this.removeLayersandInteractions(),this._hideidMap&&this._mapService.removeHideMap(this._hideidMap.id),this._hideidMap=this._previousExtent=this._catastoLayer=this._layer=this._interactions=this._outputformat=this._map_image=this._keyPickedEvent=this._currentId=this._intersectLayer=null,this.state.buttonToggled=null,this.state.loading=!1,this.removeEvent("picked-particella"),this.removeEvent("disable-all-interactions")},this.unload=function(){this.clear(),this._cachedFeatures=null,this._mapService=null,this._wrapMethods={}},this.disableInteractions=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.all,i=void 0!==e&&e;for(var n in this._interactions)i?this._interactions[n].setActive(!1):"pick_feature"!==n?this._interactions[n].setActive(!1):null;this._selectInteraction.getFeatures().clear(),this._selectInteraction.setActive(!1),this._activeInteraction=null,this.state.buttonToggled=null},this.disableAllInteractions=function(){for(var t in this._interactions)this._interactions[t].setActive(!1);this._selectInteraction.setActive(!1),this.state.buttonToggled=null,this.emit("disable-all-interactions")},this._getInteraction=function(t){return this._interactions[t]},this._selectAllFeatures=function(){this._selectInteraction.getFeatures().clear();var t=this._selectInteraction.getFeatures(),e=!0,i=!1,n=void 0;try{for(var a,o=this._layer.getSource().getFeatures()[Symbol.iterator]();!(e=(a=o.next()).done);e=!0){var r=a.value;t.push(r)}}catch(s){i=!0,n=s}finally{try{!e&&o["return"]&&o["return"]()}finally{if(i)throw n}}},this.disablePanel=function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];s.disableElement({element:".cdu-search-panel",disable:t})},this.activeInteraction=function(t){var e=["move","modify","rotate"];if(this.state.buttonToggled=this.state.buttonToggled!==t?t:null,!this.state.buttonToggled)return void this.disableInteractions();this._activeInteraction&&!(e.indexOf(this._activeInteraction)>-1)&&e.indexOf(t)>-1&&this._selectInteraction.getFeatures().clear(),this._activeInteraction=t,this._selectInteraction.setActive(!1);for(var i in this._interactions){var n=this._interactions[i];n.setActive(!1)}switch(t){case"modify":this._interactions.snap.setActive(!0);break;case"moveall":case"rotateall":this._selectAllFeatures()}this._selectInteraction.setActive(!0);var a=this._getInteraction(t);a.setActive(!0),this._mapService._unToggleControls({close:!1})},this.clearIntersectLayer=function(){this._intersectLayer.getSource().clear()},this.hightLightGeometry=function(t,e){var i={zoom:e};e&&(i.duration=1e3),this._mapService.highlightGeometry(t,i)},this.highLightIntersectFeature=function(t,e){var i=e.zoom,n=new ol.format.GeoJSON,a=n.readFeature(t);this._mapService.highlightGeometry(a.getGeometry(),{zoom:i})},this.wrapMethod=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._wrapMethods[t.name]=t.fnc},this.getWrapMethod=function(t){return this._wrapMethods[t]},this.calcola=function(t){var e=new ol.format.GeoJSON({geometryName:"geometry"}),i=this._layer.getSource().getFeatures();i.forEach(function(t){Object.keys(t.getProperties()).forEach(function(e){void 0===t.get(e)&&t.set(e,null)})});var n=e.writeFeatures(i);return $.post(t,{features:n})},this._setupHideMap=function(){var t=this;this._mapService.addHideMap({layers:[this._layer,this._mapService.createMapLayer(this._catastoLayer).getOLLayer(!0)],mainview:!1}).then(function(e){t._hideidMap=e})},this.createMapImage=function(){var t=this,e=void 0;return new Promise(function(i,n){var a=function(){t._mapService.createMapImage({map:e}).then(function(t){i(t)})["catch"](function(t){n(t)})};if(t._hideidMap){e=t._hideidMap.map;var o=t._layer.getSource().getExtent();t._previousExtent&&t._previousExtent.toString()===o.toString()?a():(t._previousExtent=o,e.once("moveend",function(){e.once("postcompose",function(){a()})}),e.getView().fit(o,e.getSize()))}else a()})}}var o=g3wsdk.core.utils.inherit,r=g3wsdk.core.utils.base,s=g3wsdk.gui.GUI,l=g3wsdk.core.i18n.t,c=g3wsdk.ol.interactions.PickCoordinatesInteraction,u=g3wsdk.core.plugin.PluginService,d=g3wsdk.core.utils.throttle;o(a,u),e.exports=new a},{}],11:[function(t,e,i){function n(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,i){function n(a,o){try{var r=e[a](o),s=r.value}catch(l){return void i(l)}return r.done?void t(s):Promise.resolve(s).then(function(t){n("next",t)},function(t){n("throw",t)})}return n("next")})}}function a(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=i.api,a=i.docurl,o=i.uploadurl;r(this,e),this.state=Object.assign({message:!1,particelle:[],showcachedbutton:c.getCachedParticelle().length>0,serverloading:!1},this.state),this.urls={api:n,docurl:a,uploadurl:o},this.catastoFields=i.search.options.filter.map(function(t){return{field:t.attribute,label:t.label}}),l.on("closecontent",function(){t.clearMessage(),Vue.nextTick(function(){t.state&&(t.state.showcachedbutton=c.getCachedParticelle().length>0)})}),c.on("disable-all-interactions",function(){t.emit("disable-all-interactions")})}var o=g3wsdk.core.utils,r=o.base,s=o.inherit,l=g3wsdk.gui.GUI,c=t("../pluginservice"),u=g3wsdk.gui.vue.services.SearchPanel,d=t("../cdu/vue/cdu"),h=g3wsdk.core.i18n.tPlugin;s(a,u);var p=a.prototype;p.deactiveMapControls=function(){c.deactiveMapControls()},p.activeGeoSearch=function(t){var e=this;t?c.on("picked-particella",function(){return e.state.serverloading=!0}):c.removeEvent("picked-particella"),c.activeGeoSearchInteraction({active:t,catastoFields:this.catastoFields,callback:function(t){var i=t.message,n=t.features;e.state.message=i,e._showContent(n),e.state.serverloading=!1}})},p.addParticelle=function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.state.messsage=c.addParticelle({particelle:t,zoom:e})},p.getCatastoFields=function(){return this.catastoFields},p._showContent=function(t,e){
if(this.state.showcachedbutton=!1,t.length){var i=!0,n=!1,a=void 0;try{for(var o,r=t[Symbol.iterator]();!(i=(o=r.next()).done);i=!0){var s=o.value;this.state.particelle.push(s)}}catch(u){n=!0,a=u}finally{try{!i&&r["return"]&&r["return"]()}finally{if(n)throw a}}var p=l.getComponent("contents");if(!p.getOpen()||!p.getComponentById("cdu")){var f=new d({urls:this.urls,catastoFields:this.catastoFields,particelle:this.state.particelle,calcola:e||c.getWrapMethod("calcola")});l.setContent({content:f,title:h("cdu.title")})}}},p.lastSearch=function(){var t=c.showCachedParticelle();this._showContent(t)},p._run=n(regeneratorRuntime.mark(function f(){var t,e,i,n,a,o,r;return regeneratorRuntime.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return t=this.createFilter(),this.state.serverloading=!0,s.prev=2,s.next=5,this.doSearch({filter:t,show:!1});case 5:e=s.sent,i=e.data,n=this._parseQueryResults(i),a=c.addParticelle({particelle:n,catastoFields:this.catastoFields}),o=a.message,r=a.features,this.state.message=o,this._showContent(r),s.next=16;break;case 13:s.prev=13,s.t0=s["catch"](2),this.state.message=null;case 16:return s.prev=16,this.state.serverloading=!1,s.finish(16);case 19:case"end":return s.stop()}},f,this,[[2,13,16,19]])})),p._parseQueryResults=function(t){return c.parseQueryResults(t)},p.closeContent=function(){l.closeContent(),this.clear(),c.clear()},p.clearMessage=function(){this.state&&(this.state.message=!1)},e.exports=a},{"../cdu/vue/cdu":6,"../pluginservice":10}],12:[function(t,e,i){e.exports='<div class="cdu-search-panel form-group">\n  <div v-show="state.serverloading" class="bar-loader" style="margin-bottom: 10px; background-color: #ffff;"></div>\n  <h4 style="font-weight: bold; margin-bottom:7px;">{{ state.title }}</h4>\n  <div id="cdu-search-tool" style="display: flex; margin-top: -5px;">\n    <button  data-toggle="tooltip" :title="tooltips.addfrommap" id="cdu-search-geo" @click="toggleGeoTool" :class="{\'skin-border-color\': geotool.active }"\n      style="padding:0 !important; position: relative; top: 10px; margin-right: 0;" class="btn btn-default skin-color skin-tooltip-top cdu-tool-button">\n      <i :class="g3wtemplate.getFontClass(\'crosshairs\')"></i>\n    </button>\n  </div>\n  <form id="cdu-search-form">\n    <template v-for="forminput in state.forminputs" :key="fortminput.name">\n      <div v-if="forminput.type == \'numberfield\'" class="form-group numeric">\n        <label :for="forminput.id + \' \'">{{ forminput.label }}</label>\n        <input type="number" v-model="forminput.value" class="form-control" :id="forminput.id">\n      </div>\n      <div v-if="forminput.type == \'textfield\' || forminput.type == \'textField\'" class="form-group text">\n        <label :for="forminput.id">{{ forminput.label }}</label>\n        <input type="text" v-model="forminput.value" class="form-control" :id="forminput.id">\n      </div>\n      <div v-if="forminput.type == \'selectfield\'" class="form-group text">\n        <label :for="forminput.id">{{ forminput.label }}</label>\n        <select v-model="forminput.value" class="form-control" :id="forminput.id">\n          <option :value="value" v-for="value in forminput.options.values" >\n            <span v-if="value === \'\'" v-t="\'sdk.search.all\'"></span>\n            <span v-else>{{ value }}</span>\n          </option>\n        </select>\n      </div>\n    </template>\n    <div class="form-group">\n      <button style="font-weight: bold" v-t-plugin="\'cdu.buttons.add\'" class="btn skin-button btn-block pull-right" @click.prevent="addParticella($event)" :disabled="state.serverloading"></button>\n      <button v-if="state.showcachedbutton" style="font-weight: bold" v-t-plugin="\'cdu.buttons.cached\'" class="btn skin-button btn-block pull-right" @click.prevent="lastSearch" :disabled="state.serverloading"></button>\n    </div>\n  </form>\n  <div :key="state.message"\n       v-show="!!state.message"\n       id="cdu-search-messages"\n       style="color:#ec971f; font-weight: bold;">\n    {{ infomessage }}\n  </div>\n</div>\n\n'},{}],13:[function(t,e,i){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.id="cdu-search-panel",t.component=c;var i=new l(t,e);t.service=i,o(this,t),this.mount=function(t,e){return o(this,"mount",t,e).then(function(){i.deactiveMapControls()})},this.unmount=function(){return o(this,"unmount").then(function(){i.closeContent()})}}var a=g3wsdk.core.utils.inherit,o=g3wsdk.core.utils.base,r=g3wsdk.core.i18n.tPlugin,s=g3wsdk.gui.vue.SearchPanel,l=t("../searchpanelservice"),c=Vue.extend({template:t("./seachpanel.html"),data:function(){return{geotool:{active:!1,message:!1},state:this.$options.service.state,tooltips:{addfrommap:r("cdu.tooltips.addfrommap")}}},computed:{infomessage:function(){return r("cdu.messages."+this.state.message)}},methods:{toggleGeoTool:function(){this.geotool.active=!this.geotool.active,this.$options.service.activeGeoSearch(this.geotool.active),$(this.$el).find(".tooltip").remove()},lastSearch:function(){this.$options.service.lastSearch()},addParticella:function(){this.state.message=!1;var t=!0,e=!1,i=void 0;try{for(var n,a=this.state.forminputs[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var o=n.value,r=!0;if(r="textfield"!==o.type?!!o.value:!!o.value&&!!o.value.trim(),!r){this.state.message="invalidform";break}}}catch(s){e=!0,i=s}finally{try{!t&&a["return"]&&a["return"]()}finally{if(e)throw i}}!this.state.message&&this.$options.service.run()}},created:function(){var t=this;this.$options.service.on("disable-all-interactions",function(){t.geotool.active=!1,t.$options.service.activeGeoSearch(t.geotool.active)})}});a(n,s),e.exports=n},{"../searchpanelservice":11,"./seachpanel.html":12}]},{},[9]);